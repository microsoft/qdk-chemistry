

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qdk_chemistry.plugins.pyscf.scf_solver &mdash; qdk-chemistry 1.0.0-rc1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css?v=4c969af8" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=a64bac2b" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=81bd8d55"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/tabs.js?v=3ee01567"></script>
      <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            qdk-chemistry
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user/comprehensive/index.html">In-depth user guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/python_api.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/cpp_api.html">C++ API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Supporting Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../glossary.html">Acronym definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">qdk-chemistry</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qdk_chemistry.plugins.pyscf.scf_solver</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qdk_chemistry.plugins.pyscf.scf_solver</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;PySCF-based Self-Consistent Field (SCF) solver implementation for qdk_chemistry.</span>

<span class="sd">This module provides integration between QDK/Chemistry and PySCF for performing</span>
<span class="sd">Self-Consistent Field calculations supporting both Hartree-Fock (HF) and</span>
<span class="sd">Density Functional Theory (DFT) methods. It implements solvers that can be</span>
<span class="sd">used within the QDK/Chemistry framework for electronic structure calculations.</span>

<span class="sd">The module contains:</span>

<span class="sd">* :class:`PyscfScfSettings`: Configuration class for SCF calculation parameters</span>
<span class="sd">* :class:`PyscfScfSolver`: Main solver class that performs HF and DFT calculations</span>
<span class="sd">* Registration utilities to integrate the solver with QDK/Chemistry&#39;s plugin system</span>

<span class="sd">The solver handles automatic conversion between QDK/Chemistry molecular structures and PySCF</span>
<span class="sd">format, performs the SCF calculation using the specified method (HF or DFT functional),</span>
<span class="sd">and returns results (energy and orbitals) in QDK/Chemistry-compatible format. It supports</span>
<span class="sd">various basis sets and exchange-correlation functionals through the settings interface.</span>

<span class="sd">Upon import, this module automatically registers the PySCF solver with QDK/Chemistry&#39;s</span>
<span class="sd">SCF solver registry under the name &quot;pyscf&quot;.</span>

<span class="sd">&gt;&gt;&gt; from qdk_chemistry.plugins.pyscf.scf_solver import PyscfScfSolver</span>
<span class="sd">&gt;&gt;&gt; solver = PyscfScfSolver()</span>
<span class="sd">&gt;&gt;&gt; solver.settings()[&quot;method&quot;] = &quot;b3lyp&quot;  # Use B3LYP DFT</span>
<span class="sd">&gt;&gt;&gt; energy, orbitals = solver.run(molecule)</span>

<span class="sd">This module requires both QDK/Chemistry and PySCF to be installed. The solver supports both</span>
<span class="sd">restricted and unrestricted variants for both HF and DFT calculations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># --------------------------------------------------------------------------------------------</span>
<span class="c1"># Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c1"># Licensed under the MIT License. See LICENSE.txt in the project root for license information.</span>
<span class="c1"># --------------------------------------------------------------------------------------------</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyscf</span><span class="w"> </span><span class="kn">import</span> <span class="n">gto</span><span class="p">,</span> <span class="n">scf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyscf.gto.mole</span><span class="w"> </span><span class="kn">import</span> <span class="n">bse_predefined_ecp</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">qdk_chemistry.algorithms</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScfSolver</span><span class="p">,</span> <span class="n">register</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qdk_chemistry.data</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Configuration</span><span class="p">,</span>
    <span class="n">ElectronicStructureSettings</span><span class="p">,</span>
    <span class="n">Orbitals</span><span class="p">,</span>
    <span class="n">SlaterDeterminantContainer</span><span class="p">,</span>
    <span class="n">Structure</span><span class="p">,</span>
    <span class="n">Wavefunction</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qdk_chemistry.plugins.pyscf.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">orbitals_to_scf</span><span class="p">,</span> <span class="n">pyscf_mol_to_qdk_basis</span><span class="p">,</span> <span class="n">structure_to_pyscf_atom_labels</span>


<div class="viewcode-block" id="PyscfScfSettings">
<a class="viewcode-back" href="../../../../api/api_autogen/qdk_chemistry.plugins.pyscf.scf_solver.html#qdk_chemistry.plugins.pyscf.scf_solver.PyscfScfSettings">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PyscfScfSettings</span><span class="p">(</span><span class="n">ElectronicStructureSettings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Settings configuration for the PySCF SCF solver.</span>

<span class="sd">    This class manages the configuration parameters for the PySCF Self-Consistent</span>
<span class="sd">    Field (SCF) solver, inheriting common electronic structure defaults from</span>
<span class="sd">    ElectronicStructureSettings and adding PySCF-specific customizations.</span>

<span class="sd">    Inherits from ElectronicStructureSettings:</span>
<span class="sd">        method (str, default=&quot;hf&quot;): The electronic structure method (Hartree-Fock).</span>
<span class="sd">        basis_set (str, default=&quot;def2-svp&quot;): The basis set used for quantum chemistry calculations.</span>
<span class="sd">            Common options include &quot;def2-svp&quot;, &quot;def2-tzvp&quot;, &quot;cc-pvdz&quot;, etc.</span>
<span class="sd">        tolerance (float, default=1e-6): Convergence tolerance.</span>
<span class="sd">        max_iterations (int, default=50): Maximum number of iterations.</span>

<span class="sd">    PySCF-specific settings:</span>
<span class="sd">        force_restricted (bool, default=False): If True, enforce restricted orbitals, even if open shell (e.g. ROHF).</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; settings = PyscfScfSettings()</span>
<span class="sd">        &gt;&gt;&gt; settings.get(&quot;basis_set&quot;)</span>
<span class="sd">        &#39;def2-svp&#39;</span>
<span class="sd">        &gt;&gt;&gt; settings.set(&quot;basis_set&quot;, &quot;cc-pvdz&quot;)</span>
<span class="sd">        &gt;&gt;&gt; settings.get(&quot;basis_set&quot;)</span>
<span class="sd">        &#39;cc-pvdz&#39;</span>

<span class="sd">    Notes:</span>
<span class="sd">        The PySCF SCF solver is used for performing self-consistent field calculations in quantum chemistry, which</span>
<span class="sd">        are fundamental for determining electronic structure and molecular properties.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PyscfScfSettings.__init__">
<a class="viewcode-back" href="../../../../api/api_autogen/qdk_chemistry.plugins.pyscf.scf_solver.html#qdk_chemistry.plugins.pyscf.scf_solver.PyscfScfSettings.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the settings with default values from ElectronicStructureSettingsplus PySCF-specific defaults.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>  <span class="c1"># This sets up all the base class defaults</span>
        <span class="c1"># Add PySCF-specific settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_default</span><span class="p">(</span><span class="s2">&quot;force_restricted&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PyscfScfSolver">
<a class="viewcode-back" href="../../../../api/api_autogen/qdk_chemistry.plugins.pyscf.scf_solver.html#qdk_chemistry.plugins.pyscf.scf_solver.PyscfScfSolver">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PyscfScfSolver</span><span class="p">(</span><span class="n">ScfSolver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PySCF-based Self-Consistent Field (SCF) solver for quantum chemistry calculations.</span>

<span class="sd">    This class provides an interface between QDK/Chemistry and PySCF for performing both Hartree-Fock (HF) and Density</span>
<span class="sd">    Functional Theory (DFT) calculations on molecular systems. It handles the conversion between QDK/Chemistry</span>
<span class="sd">    structuresand PySCF molecular representations, performs the SCF calculation, and returns the results in</span>
<span class="sd">    QDK/Chemistry-compatible format.</span>

<span class="sd">    The solver supports:</span>

<span class="sd">    * Hartree-Fock (HF): method=&quot;hf&quot; uses RHF/UHF/ROHF</span>
<span class="sd">    * DFT methods: any other method string is treated as an XC functional (e.g., &quot;b3lyp&quot;, &quot;pbe&quot;, &quot;m06&quot;)</span>

<span class="sd">    The solver automatically selects restricted/unrestricted variants based on spin</span>
<span class="sd">    and the force_restricted setting, returning electronic energy (excluding nuclear</span>
<span class="sd">    repulsion) along with molecular orbitals information.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; solver = PyscfScfSolver()</span>
<span class="sd">        &gt;&gt;&gt; solver.settings()[&quot;basis_set&quot;] = &quot;6-31G*&quot;</span>
<span class="sd">        &gt;&gt;&gt; solver.settings()[&quot;method&quot;] = &quot;b3lyp&quot;  # Use B3LYP DFT</span>
<span class="sd">        &gt;&gt;&gt; energy, orbitals = solver.run(molecule_structure, charge=0, spin_multiplicity=1)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Electronic energy: {energy} Hartree&quot;)</span>

<span class="sd">    See Also:</span>
<span class="sd">        ScfSolver : Base class for SCF solvers</span>
<span class="sd">        PyscfScfSettings : Settings configuration for PySCF calculations</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PyscfScfSolver.__init__">
<a class="viewcode-back" href="../../../../api/api_autogen/qdk_chemistry.plugins.pyscf.scf_solver.html#qdk_chemistry.plugins.pyscf.scf_solver.PyscfScfSolver.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the PySCF SCF solver with default settings.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">PyscfScfSettings</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_run_impl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">charge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">spin_multiplicity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">initial_guess</span><span class="p">:</span> <span class="n">Orbitals</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Wavefunction</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a self-consistent field (SCF) calculation using PySCF.</span>

<span class="sd">        This method converts the input structure to PySCF format, runs either a Hartree-Fock (HF) or Density Functional</span>
<span class="sd">        Theory (DFT) calculation based on the method setting, and returns the electronic energy and molecular orbitals</span>
<span class="sd">        in QDK/Chemistry format.</span>

<span class="sd">        The method automatically selects:</span>
<span class="sd">        * HF variants (RHF/UHF/ROHF) when method=&quot;hf&quot;</span>
<span class="sd">        * DFT variants (RKS/UKS/ROKS) for any other method string, treating it as an exchange-correlation functional</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The molecular or crystal structure to be calculated. Must be compatible with the</span>
<span class="sd">                ``structure_to_pyscf_atom_labels`` conversion function.</span>
<span class="sd">            charge: The total charge of the molecular system.</span>
<span class="sd">                Note: This parameter is not used directly; the charge from ``self._settings`` is used instead.</span>
<span class="sd">            spin_multiplicity: The spin multiplicity :math:`(2S+1)` of the system, where :math:`S` is the total spin.</span>
<span class="sd">                Note: This parameter is not used directly; the spin_multiplicity from ``self._settings`` is used</span>
<span class="sd">                instead.</span>
<span class="sd">            initial_guess: Initial orbital guess for the SCF calculation. If provided, the</span>
<span class="sd">                molecular orbital coefficients will be used as the starting point</span>
<span class="sd">                for the SCF iteration. If None, PySCF&#39;s default initial guess will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            * The electronic energy of the system in atomic units (Hartree), excluding nuclear repulsion energy</span>
<span class="sd">                for consistency with qdk_chemistry.</span>
<span class="sd">            * A single-determinant Slater determinant wavefunction representing the Hartree-Fock ground state.</span>

<span class="sd">        Note:</span>
<span class="sd">            The calculation uses the basis set and method specified in the settings. For DFT calculations, the method</span>
<span class="sd">            string should be a valid PySCF XC functional name (e.g., &quot;b3lyp&quot;, &quot;pbe&quot;, &quot;m06&quot;, &quot;wb97x-d&quot;).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atoms</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">structure_to_pyscf_atom_labels</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">basis_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;basis_set&quot;</span><span class="p">]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;tolerance&quot;</span><span class="p">]</span>
        <span class="n">max_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">]</span>

        <span class="c1"># The PySCF convention is 2S not 2S+1</span>
        <span class="n">multiplicity</span> <span class="o">=</span> <span class="n">spin_multiplicity</span>
        <span class="n">spin</span> <span class="o">=</span> <span class="p">(</span><span class="n">multiplicity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">multiplicity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Check effective core potentials (ECPs)</span>
        <span class="n">ecp</span><span class="p">,</span> <span class="n">ecp_atoms</span> <span class="o">=</span> <span class="n">bse_predefined_ecp</span><span class="p">(</span><span class="n">basis_name</span><span class="p">,</span> <span class="n">atoms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ecp_atoms</span><span class="p">:</span>
            <span class="n">ecp_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">ecp_atoms</span><span class="p">,</span> <span class="n">ecp</span><span class="p">)</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">Mole</span><span class="p">(</span>
            <span class="n">atom</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span>
            <span class="n">basis</span><span class="o">=</span><span class="n">basis_name</span><span class="p">,</span>
            <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span>
            <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Bohr&quot;</span><span class="p">,</span>
            <span class="n">ecp</span><span class="o">=</span><span class="n">ecp_dict</span> <span class="k">if</span> <span class="n">ecp_atoms</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mol</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="n">force_restricted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;force_restricted&quot;</span><span class="p">]</span>

        <span class="c1"># Select the appropriate SCF method based on the method setting</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;hf&quot;</span><span class="p">:</span>
            <span class="c1"># Hartree-Fock methods</span>
            <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">force_restricted</span><span class="p">:</span>
                <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">ROHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">UHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="c1"># DFT methods (Kohn-Sham)</span>
        <span class="k">elif</span> <span class="n">mol</span><span class="o">.</span><span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RKS</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">mf</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">method</span>  <span class="c1"># Set the exchange-correlation functional</span>
        <span class="k">elif</span> <span class="n">force_restricted</span><span class="p">:</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">ROKS</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">mf</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">UKS</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">mf</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">method</span>

        <span class="c1"># Configure convergence settings</span>
        <span class="n">mf</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="n">tolerance</span>
        <span class="n">mf</span><span class="o">.</span><span class="n">max_cycle</span> <span class="o">=</span> <span class="n">max_iterations</span>

        <span class="c1"># Set initial guess if provided</span>
        <span class="k">if</span> <span class="n">initial_guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">,</span> <span class="s2">&quot;get_coefficients&quot;</span><span class="p">):</span>
            <span class="c1"># Create occupation arrays based on electron configuration</span>
            <span class="n">norb</span> <span class="o">=</span> <span class="n">initial_guess</span><span class="o">.</span><span class="n">get_num_molecular_orbitals</span><span class="p">()</span>
            <span class="n">num_alpha</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Number of alpha electrons</span>
            <span class="n">num_beta</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Number of beta electrons</span>

            <span class="n">occ_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_alpha</span> <span class="k">else</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">)])</span>
            <span class="n">occ_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_beta</span> <span class="k">else</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">)])</span>

            <span class="c1"># Use utility function to convert qdk-chemistry orbitals to PySCF format</span>
            <span class="n">temp_mf</span> <span class="o">=</span> <span class="n">orbitals_to_scf</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">,</span> <span class="n">occ_alpha</span><span class="p">,</span> <span class="n">occ_beta</span><span class="p">,</span> <span class="n">force_restricted</span><span class="p">)</span>

            <span class="c1"># Extract density matrix from the temporary SCF object</span>
            <span class="n">dm0</span> <span class="o">=</span> <span class="n">temp_mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>

            <span class="c1"># Run SCF with initial density matrix</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">dm0</span><span class="o">=</span><span class="n">dm0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No initial guess provided, use default</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>

        <span class="n">basis_set</span> <span class="o">=</span> <span class="n">pyscf_mol_to_qdk_basis</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">basis_name</span><span class="p">)</span>
        <span class="n">_ovlp</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">get_ovlp</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">orbitals</span> <span class="o">=</span> <span class="n">Orbitals</span><span class="p">(</span>
                <span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span>
                <span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">,</span>
                <span class="n">ao_overlap</span><span class="o">=</span><span class="n">_ovlp</span><span class="p">,</span>
                <span class="n">basis_set</span><span class="o">=</span><span class="n">basis_set</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">force_restricted</span><span class="p">:</span>
            <span class="c1"># Create unrestricted-style orbitals but with same coefficients</span>
            <span class="n">orbitals</span> <span class="o">=</span> <span class="n">Orbitals</span><span class="p">(</span>
                <span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span>  <span class="c1"># Same coefficients for alpha and beta</span>
                <span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span>
                <span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">,</span>  <span class="c1"># Same energies for alpha and beta</span>
                <span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">,</span>
                <span class="n">ao_overlap</span><span class="o">=</span><span class="n">_ovlp</span><span class="p">,</span>
                <span class="n">basis_set</span><span class="o">=</span><span class="n">basis_set</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">force_restricted</span><span class="p">:</span>
            <span class="n">energy_a</span><span class="p">,</span> <span class="n">energy_b</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span>
            <span class="n">coeff_a</span><span class="p">,</span> <span class="n">coeff_b</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span>

            <span class="c1"># Unrestricted case - create Orbitals with alpha/beta arguments</span>
            <span class="n">orbitals</span> <span class="o">=</span> <span class="n">Orbitals</span><span class="p">(</span>
                <span class="n">coeff_a</span><span class="p">,</span>
                <span class="n">coeff_b</span><span class="p">,</span>
                <span class="n">energy_a</span><span class="p">,</span>
                <span class="n">energy_b</span><span class="p">,</span>
                <span class="n">ao_overlap</span><span class="o">=</span><span class="n">_ovlp</span><span class="p">,</span>
                <span class="n">basis_set</span><span class="o">=</span><span class="n">basis_set</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create Orbitals with restricted arguments (coeffs, occupations, energies)</span>
            <span class="n">orbitals</span> <span class="o">=</span> <span class="n">Orbitals</span><span class="p">(</span>
                <span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span>
                <span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">,</span>
                <span class="n">ao_overlap</span><span class="o">=</span><span class="n">_ovlp</span><span class="p">,</span>
                <span class="n">basis_set</span><span class="o">=</span><span class="n">basis_set</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Create Slater determinant wavefunction</span>
        <span class="n">n_alpha</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Number of alpha electrons</span>
        <span class="n">n_beta</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nelec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Number of beta electrons</span>
        <span class="n">n_orbitals</span> <span class="o">=</span> <span class="n">orbitals</span><span class="o">.</span><span class="n">get_num_molecular_orbitals</span><span class="p">()</span>

        <span class="c1"># Create HF ground state configuration using canonical method</span>
        <span class="n">hf_config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">canonical_hf_configuration</span><span class="p">(</span><span class="n">n_alpha</span><span class="p">,</span> <span class="n">n_beta</span><span class="p">,</span> <span class="n">n_orbitals</span><span class="p">)</span>

        <span class="n">wfn</span> <span class="o">=</span> <span class="n">Wavefunction</span><span class="p">(</span><span class="n">SlaterDeterminantContainer</span><span class="p">(</span><span class="n">hf_config</span><span class="p">,</span> <span class="n">orbitals</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">wfn</span>

<div class="viewcode-block" id="PyscfScfSolver.name">
<a class="viewcode-back" href="../../../../api/api_autogen/qdk_chemistry.plugins.pyscf.scf_solver.html#qdk_chemistry.plugins.pyscf.scf_solver.PyscfScfSolver.name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the name of the SCF solver.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;pyscf&quot;</span></div>
</div>



<span class="n">register</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">PyscfScfSolver</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Microsoft Corporation. All rights reserved. Licensed under the MIT License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>